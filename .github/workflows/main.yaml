# Credits: https://github.com/marketplace/actions/build-c-project
# Credits: https://www.incredibuild.com/blog/using-github-actions-with-your-c-project
# Credits: https://stackoverflow.com/questions/63606079/how-to-use-clang-10-or-gcc-10-when-building-via-github-actions

# This github workflow will automatically run upon push and is required to pass before merging to main
# to see if the code is "gradeable"

name: Assignment 1 CI

on: [push]

jobs:
  compile-and-test:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install GCC
        run: sudo apt-get install -y build-essential
      - name: Install Python3
        run: sudo apt-get install -y python3
      - name: Install zip
        run: sudo apt-get install -y zip
      - name: Unpack the submission zip
        run: unzip assignment-1/asg1.zip -d assignment-1/submission
      - name: Run sanity check on assignment 1
        run: python3 sanity_check.py asg1.zip
        working-directory: assignment-1
      - name: Compile assignment 1
        run: |
          output=$(gcc -O3 -Wall -Wextra -pthread -o guessword guessword.c -lcrypt -lpthread 2>&1 > /dev/null) || true
          if [ -n "$output" ]; then
            echo "Error: Program output to stderr"
            echo "$output"
            exit 1
          fi
        working-directory: assignment-1/submission
      - name: Run assignment 1 on testing data
        run: python3 ../src/grade.py 'timeout 15m ./guessword ../src/testing-passwd.txt ../src/testing-shadow.txt' ../src/testing-plain.txt
        working-directory: assignment-1/submission
      - name: Run assignment 1 on training data
        run: python3 ../src/grade.py 'timeout 15m ./guessword ../src/training-passwd.txt ../src/training-shadow.txt' ../src/training-plain.txt
        working-directory: assignment-1/submission
